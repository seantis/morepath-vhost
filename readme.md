The following is an example implementation of Virtual Hosting in Morepath. It
might possibly be included in Morepath in the future.

See https://github.com/morepath/morepath/issues/185

To run the tests / example:

    pip install -r requirements.txt
    python vhost.py

Only tested under Python 3!

# Virtual Hosting

## Introduction

Morepath can be made aware of the host and the path it is served under. This is
useful for a number of scenarios:

1. You want to make sure all your links point to https
2. You want to serve a Morepath application somewhere else than the site root.
3. You only want to serve part of a Morepath application.

This feature is usually called "Virtual Hosting".

## Supported by Default

Morepath's virtual hosting is a feature of the core. This means that you don't
have to worry about it. If you need it in deployment, it will be there for you.

## Fully Qualified URLs

When Morepath builds a link, it first creates the path to the model instance.

The resulting path might look like this:

    /documents/1
    /blog/posts/2014-11-17-15:00

These urls are not considered fully qualified, because they lack the hostname.
Fully qualified, these urls might look like this:

    http://example.org/documents/1
    https://blog/posts/2014-11-17-15:00

There are two situations, where we don't require fully qualified urls:

1. During development.
2. When serving Morepath on the root (e.g. on http://example.org/)

Of course, these are hardly the only situations Morepath is used in. For more
advanced situations, Morepath adjusts the url before returning it.

## Influencing the URL Creation

To have Morepath links be aware of how they are served, we can work with two
header variables. These can be set by the request or, most importantly, by the
webserver that serves our application.

Morepath pays homage to [repoze.vhm](https://pypi.python.org/pypi/repoze.vhm)
by reusing repoze.vhm's 
[header variables](https://pypi.python.org/pypi/repoze.vhm#id23).

### X_VHM_HOST

`X_VHM_HOST` acts like a prefix to all links generated by Morepath. If this
variable is not empty, it will be added in front of all generated urls.

For example, `/user/admin` becomes `https://secure.example.org/user/admin`, if
`X_VHM_HOST` is set to `https://secure.example.org`.

Note that this doesn't mean you *have* to give the protocol and host. See
[Hosting Part of a Morepath Application][] for an example where this is not
the case.

### X_VHM_ROOT

`X_VHM_ROOT` is a bit more tricky. It tells Morepath where the root of the
application is situated. This means that the value of `X_VHM_ROOT` must
be an existing path inside of Morepath.

We can understand this best with an example. Let's say you have a Morepath
application that serves a blog under `/blog`. You now want to serve the blog
under a separate domain, say `blog.example.org`.

If we just served Morepath under blog.example.org, we'd get urls like this one:

    blog.example.org/blog/posts/2014-11-17-16:00

In effect, this subdomain would be no different from example.org (without the
blog subdomain). However, we want the root of the host to point to `/blog`.

To do this we set `X_VHM_ROOT` to `/blog`. Morepath will then automatically
return urls like this:

    blog.example.org/posts/2014-11-17-16:00

## Examples

Since virtual hosting is mostly a deployment issue, the best way really show
how everything works, is by example.

The following are examples showing different ways of serving Morepath on Nginx.
We are happy to include examples to other webservers.

### Forcing the Generation of HTTPS Links

    server {
        server_name secure.morepath.dev;
        listen *:443 ssl;

        ssl_certificate        /etc/ssl/secure.morepath.dev.pem;
        ssl_certificate_key    /etc/ssl/secure.morepath.dev.key;

        location / {
            proxy_pass http://127.0.0.1:5000/;

            proxy_set_header X-Vhm-Root '';
            proxy_set_header X-Vhm-Host https://secure.morepath.dev;
        }
    }

### Hosting Morepath on a Different Location

    server {
        server_name www.morepath.dev;
        listen *:80;

        location /my-location {
            proxy_pass http://127.0.0.1:5000/;

            proxy_set_header X-Vhm-Root '';
            proxy_set_header X-Vhm-Host /my-location/;
        }
    }

### Hosting Part of a Morepath Application

    server {
        server_name blog.morepath.dev;
        listen *:80;

        location / {
            proxy_pass http://127.0.0.1:5000/blog/;

            proxy_set_header X-Vhm-Root /blog;
            proxy_set_header X-Vhm-Host '';
        }
    }


### Hosting Part of a Morepath Application on a Different Location

    server {
        server_name www.morepath.dev;
        listen *:80;

        location /blog {
            proxy_pass http://127.0.0.1:5000/blog/;

            proxy_set_header X-Vhm-Root /blog;
            proxy_set_header X-Vhm-Host '';
        }
    }
